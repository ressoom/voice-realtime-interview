{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///Users/omkumarsolanki/WorkSpace/Resso/avatar-mircroservice/web/app/page.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { Mic, MicOff, Activity, MessageSquare, AlertCircle, Play } from 'lucide-react';\n\n/** \n * MINIMAL VOICE LAB\n * This component connects to ws://localhost:8000/ws\n * It handles: \n * 1. Mic capture (48k -> 24k downsample)\n * 2. WebSocket streaming (PCM16)\n * 3. Real-time transcript display\n * 4. AI Audio playback\n */\n\nconst App = () => {\n  // --- State ---\n  const [isActive, setIsActive] = useState(false);\n  const [status, setStatus] = useState('Disconnected');\n  const [transcript, setTranscript] = useState('');\n  const [error, setError] = useState(null);\n  const [volume, setVolume] = useState(0);\n\n  // --- Refs for Audio/WS ---\n  const wsRef = useRef(null);\n  const audioCtxRef = useRef(null);\n  const micStreamRef = useRef(null);\n  const processorRef = useRef(null);\n  const playbackCtxRef = useRef(null);\n  const nextStartTimeRef = useRef(0);\n\n  // --- 1. Audio Utilities ---\n  const float32To16BitPCM = (float32) => {\n    const buffer = new ArrayBuffer(float32.length * 2);\n    const view = new DataView(buffer);\n    for (let i = 0; i < float32.length; i++) {\n      let s = Math.max(-1, Math.min(1, float32[i]));\n      s = s < 0 ? s * 0x8000 : s * 0x7fff;\n      view.setInt16(i * 2, s, true);\n    }\n    return buffer;\n  };\n\n  const downsample = (input, srcRate, targetRate) => {\n    if (srcRate === targetRate) return input;\n    const ratio = srcRate / targetRate;\n    const newLength = Math.floor(input.length / ratio);\n    const result = new Float32Array(newLength);\n    for (let i = 0; i < newLength; i++) {\n      result[i] = input[Math.floor(i * ratio)];\n    }\n    return result;\n  };\n\n  // --- 2. Playback Logic (AI Voice) ---\n  const playAudioChunk = async (base64) => {\n    if (!playbackCtxRef.current) {\n      playbackCtxRef.current = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });\n    }\n    const ctx = playbackCtxRef.current;\n    \n    try {\n      const binary = atob(base64);\n      const bytes = new Uint8Array(binary.length);\n      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);\n      \n      const pcm16 = new Int16Array(bytes.buffer);\n      const float32 = new Float32Array(pcm16.length);\n      for (let i = 0; i < pcm16.length; i++) float32[i] = pcm16[i] / 32768;\n\n      const audioBuffer = ctx.createBuffer(1, float32.length, 24000);\n      audioBuffer.getChannelData(0).set(float32);\n\n      const source = ctx.createBufferSource();\n      source.buffer = audioBuffer;\n      source.connect(ctx.destination);\n\n      const startTime = Math.max(ctx.currentTime, nextStartTimeRef.current);\n      source.start(startTime);\n      nextStartTimeRef.current = startTime + audioBuffer.duration;\n    } catch (e) {\n      console.error(\"Playback error\", e);\n    }\n  };\n\n  // --- 3. WebSocket & Mic Lifecycle ---\n  const stopSession = useCallback(() => {\n    setIsActive(false);\n    setStatus('Disconnected');\n    \n    if (wsRef.current) wsRef.current.close();\n    if (micStreamRef.current) micStreamRef.current.getTracks().forEach(t => t.stop());\n    if (audioCtxRef.current) audioCtxRef.current.close();\n    \n    wsRef.current = null;\n    micStreamRef.current = null;\n    audioCtxRef.current = null;\n  }, []);\n\n  const startSession = async () => {\n    setError(null);\n    setTranscript('');\n    setVolume(0);\n    nextStartTimeRef.current = 0;\n\n    try {\n      // A. Connect WebSocket\n      const ws = new WebSocket('ws://localhost:8000/ws');\n      wsRef.current = ws;\n      setStatus('Connecting...');\n\n      ws.onopen = () => setStatus('Connected & Listening');\n      ws.onclose = () => stopSession();\n      ws.onerror = () => setError('WebSocket Connection Failed');\n      \n      ws.onmessage = (e) => {\n        const msg = JSON.parse(e.data);\n        if (msg.type === 'text_delta') {\n          setTranscript(prev => prev + ' ' + msg.data);\n        } else if (msg.type === 'audio_delta') {\n          playAudioChunk(msg.data);\n        }\n      };\n\n      // B. Start Mic\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n      micStreamRef.current = stream;\n      \n      const audioCtx = new AudioContext();\n      audioCtxRef.current = audioCtx;\n      const source = audioCtx.createMediaStreamSource(stream);\n      const processor = audioCtx.createScriptProcessor(4096, 1, 1);\n      \n      processor.onaudioprocess = (e) => {\n        const input = e.inputBuffer.getChannelData(0);\n        \n        // Calculate volume for UI\n        let sum = 0;\n        for(let i=0; i<input.length; i++) sum += input[i]*input[i];\n        setVolume(Math.sqrt(sum / input.length) * 100);\n\n        // Process & Send\n        const resampled = downsample(input, audioCtx.sampleRate, 24000);\n        const pcm16 = float32To16BitPCM(resampled);\n        const base64 = btoa(String.fromCharCode(...new Uint8Array(pcm16)));\n        \n        if (ws.readyState === WebSocket.OPEN) {\n          ws.send(JSON.stringify({ type: 'audio_chunk', data: base64 }));\n        }\n      };\n\n      source.connect(processor);\n      processor.connect(audioCtx.destination); // Required for some browsers to keep process alive\n      setIsActive(true);\n\n    } catch (err) {\n      setError(err.message);\n      stopSession();\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-slate-50 p-8 font-sans text-slate-900\">\n      <div className=\"max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200\">\n        \n        {/* Header */}\n        <div className=\"bg-slate-900 p-6 text-white flex justify-between items-center\">\n          <div>\n            <h1 className=\"text-xl font-bold flex items-center gap-2\">\n              <Activity className=\"text-blue-400\" size={20} />\n              Voice AI Lab\n            </h1>\n            <p className=\"text-slate-400 text-xs mt-1\">Target: ws://localhost:8000/ws</p>\n          </div>\n          <div className={`px-3 py-1 rounded-full text-xs font-medium flex items-center gap-2 ${\n            isActive ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-400'\n          }`}>\n            <div className={`w-2 h-2 rounded-full ${isActive ? 'bg-green-500 animate-pulse' : 'bg-slate-500'}`} />\n            {status}\n          </div>\n        </div>\n\n        {/* Main Controls */}\n        <div className=\"p-8 flex flex-col items-center gap-8\">\n          \n          {/* Visualizer Orb */}\n          <div className=\"relative\">\n            <div \n              className=\"w-32 h-32 rounded-full bg-slate-100 flex items-center justify-center transition-all duration-75 border-4 border-white shadow-inner\"\n              style={{ \n                boxShadow: isActive ? `0 0 ${volume * 2}px rgba(59, 130, 246, 0.5)` : 'none',\n                transform: `scale(${1 + (volume / 200)})`\n              }}\n            >\n              {isActive ? (\n                <Mic className=\"text-blue-600 animate-bounce\" size={40} />\n              ) : (\n                <MicOff className=\"text-slate-300\" size={40} />\n              )}\n            </div>\n          </div>\n\n          {/* Action Button */}\n          {!isActive ? (\n            <button \n              onClick={startSession}\n              className=\"w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-200\"\n            >\n              <Play size={20} fill=\"currentColor\" />\n              Start Real-Time Session\n            </button>\n          ) : (\n            <button \n              onClick={stopSession}\n              className=\"w-full py-4 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 shadow-lg shadow-red-200\"\n            >\n              <div className=\"w-3 h-3 bg-white rounded-sm\" />\n              Stop Session\n            </button>\n          )}\n\n          {/* Error Display */}\n          {error && (\n            <div className=\"w-full p-4 bg-red-50 border border-red-100 rounded-lg flex items-start gap-3 text-red-700 text-sm\">\n              <AlertCircle size={18} className=\"shrink-0 mt-0.5\" />\n              <p>{error}</p>\n            </div>\n          )}\n        </div>\n\n        {/* Transcript Area */}\n        <div className=\"border-t border-slate-100 bg-slate-50 p-6\">\n          <div className=\"flex items-center gap-2 mb-4 text-slate-500 font-semibold text-sm uppercase tracking-wider\">\n            <MessageSquare size={16} />\n            Live Transcript\n          </div>\n          <div className=\"bg-white border border-slate-200 rounded-xl p-4 min-h-[150px] max-h-[300px] overflow-y-auto text-slate-700 leading-relaxed shadow-sm\">\n            {transcript || (\n              <span className=\"text-slate-300 italic\">\n                {isActive ? 'Listening for your voice...' : 'Transcript will appear here once session starts.'}\n              </span>\n            )}\n          </div>\n        </div>\n\n        {/* Footer Info */}\n        <div className=\"p-4 bg-slate-100 text-[10px] text-slate-400 text-center uppercase tracking-widest\">\n          PCM16 @ 24kHz • Mono • Real-Time Streaming\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default App;"],"names":[],"mappings":"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"}}]
}